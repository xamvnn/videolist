<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Grid with Video Playback</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js" defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
    }

    .container {
      max-width: 1200px;
      min-width: 320px;
      padding: 20px;
      box-sizing: border-box;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 24px;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }

    .media-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .media-card .thumbnail-container {
      width: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #000;
      position: relative;
    }

    .media-card img {
      width: 100%;
      height: auto;
      object-fit: cover;
      aspect-ratio: auto;
      loading: lazy;
    }

    .media-card video {
      width: 100%;
      height: auto;
      display: none;
    }

    .media-card p {
      margin: 8px;
      font-size: 14px;
      line-height: 1.4;
      min-height: 40px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .viewed {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0, 255, 0, 0.7);
      color: white;
      padding: 5px;
      border-radius: 5px;
      font-size: 12px;
    }

    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.7);
      padding: 5px 10px;
      border-radius: 5px;
      display: none;
      z-index: 10;
    }

    button {
      margin: 5px;
      padding: 5px 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .video-controls {
      display: none;
      flex-wrap: wrap;
      gap: 5px;
      margin: 5px;
    }

    .video-controls.show {
      display: flex;
    }

    .video-controls button {
      font-size: 12px;
      padding: 5px 8px;
    }

    .video-controls .skip-button {
      font-size: 14px;
      padding: 5px 10px;
    }

    .video-controls button.active {
      background: #28a745;
    }

    #errorMessage {
      color: red;
      text-align: center;
      margin-bottom: 10px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .pagination button {
      margin: 0 5px;
    }

    .pagination span {
      margin: 0 10px;
      font-size: 14px;
    }

    .subscribe-text {
      text-align: center;
      margin-bottom: 10px;
      color: #333;
      font-size: 14px;
    }

    .subscribe-text a {
      color: #ff0000;
      text-decoration: none;
      font-weight: 600;
    }

    .subscribe-text a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }

      .media-card p {
        font-size: 10px;
        min-height: 30px;
      }

      .video-controls button {
        font-size: 10px;
        padding: 4px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Media Grid</h1>
    <div class="subscribe-text">
      tml xin ủng hộ 1 sub nhé: <a href="https://www.youtube.com/@coilong864?sub_confirmation=1" target="_blank">Kênh YouTube</a>
    </div>
    <div id="errorMessage"></div>
    <select id="sort" onchange="sortMedia()">
      <option value="title">Title</option>
    </select>
    <div id="mediaGrid" class="media-grid"></div>
    <div class="pagination">
      <button id="prevPage" onclick="changePage(-1)" disabled>Previous</button>
      <span id="pageInfo"></span>
      <button id="nextPage" onclick="changePage(1)">Next</button>
    </div>
  </div>
  <script>
    let mediaData = [];
    let viewedItems = new Set(JSON.parse(localStorage.getItem('viewedItems') || '[]'));
    let currentPage = 1;
    const itemsPerPage = 12;

    function parseCSV(csvText) {
      try {
        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        const result = parsed.data
          .filter(row => row.url && row.title)
          .map((row, index) => ({
            id: row.id || `video-${index + 1}`,
            url: row.url.trim(),
            title: row.title.trim(),
            thumb: row.thumb ? row.thumb.trim() : 'https://via.placeholder.com/150?text=Video',
            size_formatted: row.size_formatted || 'Unknown',
            how_long_ago: row.how_long_ago || 'Unknown'
          }));
        if (parsed.errors.length > 0) {
          console.warn('Lỗi khi parse CSV:', parsed.errors);
        }
        return result;
      } catch (err) {
        console.error('Lỗi parse CSV:', err);
        document.getElementById('errorMessage').textContent = 'Lỗi khi phân tích file CSV.';
        return [];
      }
    }

    function savePlaybackSpeed(video, speed) {
      localStorage.setItem(`playbackSpeed_${video.src}`, speed);
    }

    function getSavedPlaybackSpeed(video) {
      const savedSpeed = localStorage.getItem(`playbackSpeed_${video.src}`);
      return savedSpeed !== null ? parseFloat(savedSpeed) : 1;
    }

    function createMediaCard(item) {
      const card = document.createElement('div');
      card.className = 'media-card';
      const viewedMark = viewedItems.has(item.id) ? '<span class="viewed">Viewed</span>' : '';
      card.innerHTML = `
        <div class="thumbnail-container">
          <img src="${item.thumb}" alt="${item.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/150?text=Video'">
          ${viewedMark}
          <div class="loading-indicator">Đang tải...</div>
        </div>
        <p><b>${item.title}</b></p>
        <p>Size: ${item.size_formatted}</p>
        <p>Uploaded: ${item.how_long_ago}</p>
        <button onclick="event.stopPropagation(); playVideo(this, '${item.url}')">Play</button>
        <button onclick="event.stopPropagation(); markAsViewed('${item.id}')">Mark as ${viewedItems.has(item.id) ? 'Unviewed' : 'Viewed'}</button>
        <div class="video-controls">
          <button onclick="event.stopPropagation(); prevVideo(this)">Previous</button>
          <button onclick="event.stopPropagation(); pauseVideo(this)">Pause</button>
          <button onclick="event.stopPropagation(); nextVideo(this)">Next</button>
          <button class="skip-button" onclick="event.stopPropagation(); skipForward(this)">+10s</button>
          <button onclick="event.stopPropagation(); setPlaybackSpeed(this, 1.5)">x1.5</button>
          <button onclick="event.stopPropagation(); setPlaybackSpeed(this, 2)">x2</button>
          <button onclick="event.stopPropagation(); setPlaybackSpeed(this, 3)">x3</button>
          <button onclick="event.stopPropagation(); setPlaybackSpeed(this, 4)">x4</button>
          <button onclick="event.stopPropagation(); setPlaybackSpeed(this, 6)">x6</button>
          <button onclick="event.stopPropagation(); setPlaybackSpeed(this, 8)">x8</button>
        </div>
      `;
      return card;
    }

    function playVideo(button, videoUrl) {
      const card = button.parentElement;
      const img = card.querySelector('img');
      let video = card.querySelector('video');
      const videoControls = card.querySelector('.video-controls');
      const loadingIndicator = card.querySelector('.loading-indicator');
      const errorMessage = document.getElementById('errorMessage');

      if (!video) {
        video = document.createElement('video');
        video.src = videoUrl;
        video.preload = 'metadata';
        video.controls = true;
        video.style.display = 'none';
        card.querySelector('.thumbnail-container').appendChild(video);
      }

      loadingIndicator.style.display = 'block';
      img.style.display = 'none';
      video.style.display = 'block';
      videoControls.classList.add('show');

      let retries = 0;
      const maxRetries = 3;
      const retryDelay = 1000;

      function attemptPlay() {
        const playPromise = video.play();
        if (playPromise) {
          playPromise
            .then(() => {
              loadingIndicator.style.display = 'none';
              const id = button.nextElementSibling.getAttribute('onclick').match(/'([^']+)'/)[1];
              if (!viewedItems.has(id)) {
                markAsViewed(id);
              }
              video.playbackRate = getSavedPlaybackSpeed(video);
              updateSpeedButtons(video, card);
              updatePauseButton(video, card);
            })
            .catch(err => {
              console.error(`Failed to play video: ${video.src}`, err);
              if (retries < maxRetries) {
                retries++;
                setTimeout(attemptPlay, retryDelay * Math.pow(2, retries));
              } else {
                errorMessage.textContent = `Không thể phát video: ${err.message}. Vui lòng kiểm tra định dạng hoặc kết nối.`;
                img.style.display = 'block';
                video.style.display = 'none';
                videoControls.classList.remove('show');
                loadingIndicator.style.display = 'none';
              }
            });
        }
      }

      video.addEventListener('error', () => {
        errorMessage.textContent = `Lỗi tải video: ${video.src}. Vui lòng kiểm tra URL hoặc định dạng video.`;
        img.style.display = 'block';
        video.style.display = 'none';
        videoControls.classList.remove('show');
        loadingIndicator.style.display = 'none';
      }, { once: true });

      video.addEventListener('canplay', attemptPlay, { once: true });
      video.load();
      video.addEventListener('ended', () => nextVideo(button), { once: true });
    }

    function updateSpeedButtons(video, card) {
      const speedButtons = card.querySelectorAll('.video-controls button:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3))');
      speedButtons.forEach(button => {
        button.classList.remove('active');
        if (button.textContent === `x${video.playbackRate}`) {
          button.classList.add('active');
        }
      });
    }

    function setPlaybackSpeed(button, speed) {
      const card = button.parentElement.parentElement;
      const video = card.querySelector('video');
      if (video) {
        if (video.playbackRate === speed) {
          video.playbackRate = 1;
          savePlaybackSpeed(video, 1);
        } else {
          video.playbackRate = speed;
          savePlaybackSpeed(video, speed);
        }
        updateSpeedButtons(video, card);
      }
    }

    function skipForward(button) {
      const card = button.parentElement.parentElement;
      const video = card.querySelector('video');
      if (video) {
        video.currentTime += 10;
      }
    }

    function pauseVideo(button) {
      const card = button.parentElement.parentElement;
      const video = card.querySelector('video');
      if (video) {
        if (video.paused) {
          video.play();
          button.textContent = 'Pause';
        } else {
          video.pause();
          button.textContent = 'Play';
        }
        updatePauseButton(video, card);
      }
    }

    function updatePauseButton(video, card) {
      const pauseButton = card.querySelector('.video-controls button:nth-child(2)');
      pauseButton.textContent = video.paused ? 'Play' : 'Pause';
    }

    function prevVideo(button) {
      const index = mediaData.findIndex(item => item.url === button.parentElement.parentElement.querySelector('video')?.src);
      if (index > 0) {
        playVideoByIndex(index - 1);
      }
    }

    function nextVideo(button) {
      const index = mediaData.findIndex(item => item.url === button.parentElement.parentElement.querySelector('video')?.src);
      if (index < mediaData.length - 1) {
        playVideoByIndex(index + 1);
      } else {
        playVideoByIndex(0);
      }
    }

    function playVideoByIndex(index) {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      if (index >= start && index < end) {
        const card = document.getElementById('mediaGrid').children[index - start];
        const playButton = card.querySelector('button[onclick*="playVideo"]');
        playVideo(playButton, mediaData[index].url);
      } else {
        currentPage = Math.floor(index / itemsPerPage) + 1;
        requestAnimationFrame(() => {
          renderPage();
          const newIndex = index % itemsPerPage;
          const card = document.getElementById('mediaGrid').children[newIndex];
          const playButton = card.querySelector('button[onclick*="playVideo"]');
          playVideo(playButton, mediaData[index].url);
        });
      }
    }

    function markAsViewed(id) {
      if (viewedItems.has(id)) {
        viewedItems.delete(id);
      } else {
        viewedItems.add(id);
      }
      localStorage.setItem('viewedItems', JSON.stringify([...viewedItems]));
      requestAnimationFrame(renderPage);
    }

    function updatePagination() {
      const totalPages = Math.ceil(mediaData.length / itemsPerPage);
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
    }

    function renderPage() {
      const mediaGrid = document.getElementById('mediaGrid');
      const errorMessage = document.getElementById('errorMessage');
      mediaGrid.innerHTML = '';
      errorMessage.textContent = '';

      if (!mediaData || mediaData.length === 0) {
        errorMessage.textContent = 'Không có dữ liệu video để hiển thị.';
        return;
      }

      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = mediaData.slice(start, end);
      pageItems.forEach(item => mediaGrid.appendChild(createMediaCard(item)));
      updatePagination();
    }

    function changePage(direction) {
      const totalPages = Math.ceil(mediaData.length / itemsPerPage);
      currentPage = Math.min(Math.max(1, currentPage + direction), totalPages);
      requestAnimationFrame(renderPage);
    }

    function sortMedia() {
      const sortKey = document.getElementById('sort').value;
      mediaData.sort((a, b) => {
        return a[sortKey]?.localeCompare(b[sortKey]) || 0;
      });
      currentPage = 1;
      requestAnimationFrame(renderPage);
    }

    function loadCSV() {
      const errorMessage = document.getElementById('errorMessage');
      const cachedData = localStorage.getItem('cachedMediaData');
      if (cachedData) {
        mediaData = JSON.parse(cachedData);
        if (mediaData.length > 0) {
          requestAnimationFrame(renderPage);
          return;
        }
      }

      errorMessage.textContent = '';
      fetch('https://raw.githubusercontent.com/xamvnn/videolist/main/data.csv')
        .then(response => {
          if (!response.ok) {
            throw new Error('Không thể tải data.csv');
          }
          return response.text();
        })
        .then(csvText => {
          mediaData = parseCSV(csvText);
          if (mediaData.length === 0) {
            errorMessage.textContent = 'Không tìm thấy dữ liệu hợp lệ trong CSV.';
            return;
          }
          localStorage.setItem('cachedMediaData', JSON.stringify(mediaData));
          requestAnimationFrame(renderPage);
        })
        .catch(err => {
          errorMessage.textContent = 'Lỗi khi tải file CSV: ' + err.message;
          console.error('Lỗi tải CSV:', err);
        });
    }

    document.addEventListener('DOMContentLoaded', loadCSV);
  </script>
</body>
</html>
